<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    :root { --bg-color: #F7F9F9; --accent-blue: #1A73E8; }
    body { font-family: 'Segoe UI', Tahoma, sans-serif; padding: 10px; background-color: var(--bg-color); color: #546E7A; text-align: center; margin: 0; }
    .card { background: white; padding: 30px 20px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); max-width: 400px; margin: 20px auto; box-sizing: border-box; }
    .pos-btn { display: block; width: 100%; padding: 18px; margin: 12px 0; font-size: 19px; border: none; border-radius: 15px; cursor: pointer; font-weight: bold; color: #546E7A; transition: 0.3s; text-decoration: none; }
    .btn-site { background-color: #D4EBF8; } .btn-in { background-color: #E1F0DA; } .btn-out { background-color: #FFF9C4; }
    .btn-report { background-color: #FFCCBC; color: #BF360C; } .btn-expense { background-color: #FFE0B2; color: #E65100; }
    .status-display { font-size: 24px; font-weight: 900; color: var(--accent-blue); background: #E3F2FD; padding: 15px; border-radius: 15px; margin-bottom: 20px; }
    input, select, textarea { width: 100%; padding: 15px; margin-bottom: 15px; border: 1px solid #ECEFF1; border-radius: 12px; box-sizing: border-box; font-size: 16px; background: #FAFAFA; text-align: center; font-family: inherit; }
    .main-btn { padding: 18px; font-size: 18px; width: 100%; cursor: pointer; background-color: #A5D6A7; color: white; border: none; border-radius: 15px; font-weight: bold; margin-top: 10px; }
    .section-title { font-weight: bold; color: var(--accent-blue); margin-bottom: 15px; text-align: left; }
    #page-record, #extra-questions, #report-section, #site-section, #expense-section, #expense-upload, #expense-summary, #finish-msg { display: none; }
  </style>
</head>
<body>

  <div id="page-welcome" class="card">
    <h2 style="color:#78909C;">CODE of 2026 SCIn</h2>
    <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</p>
    <button type="button" class="pos-btn btn-site" onclick="selectStatus('Site Check In')">üìç Site Check In (‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏ã‡∏ï‡πå)</button>
    <button type="button" class="pos-btn btn-in" onclick="selectStatus('Check In')">üí™ Check In (‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô)</button>
    <button type="button" class="pos-btn btn-out" onclick="selectStatus('Check Out')">üò¥ Check Out (‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô)</button>
    <button type="button" class="pos-btn btn-report" onclick="selectStatus('Report')">üìù Report (‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô)</button>
    <button type="button" class="pos-btn btn-expense" onclick="selectStatus('Expenses')">üí∞ Expenses (‡πÄ‡∏ö‡∏¥‡∏Å‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢)</button>
  </div>

  <div id="page-record" class="card">
    <div id="display-status" class="status-display">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: </div>
    <div id="status-text" style="margin-bottom:15px; font-weight:bold; color:orange;">‚è≥ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>

    <input type="text" id="userName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á)">
    <select id="userRegion">
      <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î‡∏†‡∏≤‡∏Ñ (‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö) --</option>
      <option>BKK</option><option>CR</option><option>ER</option><option>NER</option><option>NR</option><option>SR</option><option>TE</option><option>DR</option><option>OFFICE</option>
    </select>

    <div id="extra-questions">
      <input type="text" id="q_with" placeholder="‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Å‡∏±‡∏ö‡πÉ‡∏Ñ‡∏£ (‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô)">
      <select id="q_car" onchange="document.getElementById('q_car_name').style.display=(this.value=='‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô'?'block':'none')">
        <option value="‡∏£‡∏ñ‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á">‡πÉ‡∏ä‡πâ‡∏£‡∏ñ‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á</option>
        <option value="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô">‡πÉ‡∏ä‡πâ‡∏£‡∏ñ‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô (‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô)</option>
      </select>
      <input type="text" id="q_car_name" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏£‡∏ñ" style="display:none;">
      <input type="number" id="q_mile" placeholder="‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏£ (‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)">
      <select id="q_loc">
        <option value="">‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô/‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏≠‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏´‡∏ô? (‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)</option>
        <option value="‡∏≠‡∏≠‡∏ü‡∏ü‡∏¥‡∏ï">‡∏≠‡∏≠‡∏ü‡∏ü‡∏¥‡∏ï</option>
        <option value="‡∏ö‡πâ‡∏≤‡∏ô/‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å">‡∏ö‡πâ‡∏≤‡∏ô/‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å</option>
        <option value="‡πÇ‡∏£‡∏á‡πÅ‡∏£‡∏°">‡πÇ‡∏£‡∏á‡πÅ‡∏£‡∏°</option>
      </select>
      <textarea id="q_plan" rows="3" placeholder="PLAN / BRIFE (‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏Å‡∏£‡∏≠‡∏Å)"></textarea>
    </div>

    <div id="report-section">
      <input type="date" id="q_date_rep">
      <select id="q_type" onchange="document.getElementById('q_type_etc').style.display=(this.value=='‡∏á‡∏≤‡∏ô ‡∏≠‡∏∑‡πà‡∏ô ‡πÜ'?'block':'none')">
        <option value="">-- ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô --</option>
        <option>‡∏á‡∏≤‡∏ô CR</option><option>‡∏á‡∏≤‡∏ô OFFICE</option><option>‡∏á‡∏≤‡∏ô TE</option><option>‡∏á‡∏≤‡∏ô DRONE</option><option>‡∏á‡∏≤‡∏ô ‡∏≠‡∏∑‡πà‡∏ô ‡πÜ</option>
      </select>
      <input type="text" id="q_type_etc" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏ô‡∏¥‡∏î‡∏á‡∏≤‡∏ô" style="display:none;">
      <textarea id="q_job_detail" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô"></textarea>
    </div>

    <div id="site-section"><div id="site-container"></div></div>

    <div id="expense-section">
      <input type="date" id="ex_date">
      <input type="text" id="ex_site" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ã‡∏ï‡πå">
      <input type="number" id="ex_oil" placeholder="‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô (‡∏ö‡∏≤‡∏ó)">
      <input type="number" id="ex_hotel" placeholder="‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å (‡∏ö‡∏≤‡∏ó)">
      <input type="number" id="ex_ccr" placeholder="‡∏Ñ‡πà‡∏≤‡∏Ç‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Ñ‡∏° (‡∏ö‡∏≤‡∏ó)">
      <input type="number" id="ex_trav" placeholder="‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á (‡∏ö‡∏≤‡∏ó)">
    </div>

    <div id="expense-upload">
      <div class="section-title">üì∏ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏ö‡∏¥‡∏• (‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 10 ‡∏£‡∏π‡∏õ)</div>
      <input type="file" id="ex_files" accept="image/*" multiple onchange="selectedFiles=Array.from(this.files); document.getElementById('f-count').innerText='‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß '+selectedFiles.length+' ‡∏£‡∏π‡∏õ'">
      <div id="f-count" style="color:green; margin-bottom:10px; font-size:12px;"></div>
    </div>

    <div id="expense-summary">
      <div id="sum-total" style="font-size:20px; font-weight:bold; color:#2e7d32; margin-bottom:20px;"></div>
      <button type="button" class="main-btn" style="background:#2e7d32;" onclick="confirmExpenseFinal()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
    </div>

    <button type="button" id="btn-action" class="main-btn" onclick="handleFlow()">‡∏ï‡∏Å‡∏•‡∏á</button>

    <div id="finish-msg">
      <div style="font-size: 60px; color: #4CAF50;"><i class="fas fa-check-circle"></i></div>
      <div id="finish-text-1" style="font-size: 16px; margin: 15px 0; line-height: 1.5;"></div>
      <div id="finish-text-2" style="font-weight: bold; color: #EF5350; font-size: 18px;"></div>
      <button type="button" class="main-btn" onclick="location.reload()" style="background:#1A73E8; margin-top:20px;">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button>
    </div>
  </div>

  <input type="file" id="fileInput" accept="image/*" capture="camera" style="display:none" onchange="uploadPhoto(this)">

<script>
  const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwk-spmOFdk-ZLRHhTkJXUshNWmJ6DqvdbNqUByszqLMDVujm7XFe0by-VDVUmNgZmuoQ/exec";
  var selectedStatus = "", reportStep = 1, siteIdx = 1, expenseStep = 1, selectedFiles = [];

  function selectStatus(status) {
    selectedStatus = status;
    document.getElementById('page-welcome').style.display = 'none';
    document.getElementById('page-record').style.display = 'block';
    document.getElementById('display-status').innerText = status;
    document.getElementById('extra-questions').style.display = (['Check In','Check Out'].includes(status)) ? 'block' : 'none';
    document.getElementById('report-section').style.display = (status === 'Report') ? 'block' : 'none';
    document.getElementById('expense-section').style.display = (status === 'Expenses') ? 'block' : 'none';
    if(status==='Check Out') document.getElementById('q_plan').placeholder = "BRIFE: ‡∏™‡∏£‡∏∏‡∏õ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏Å‡∏£‡∏≠‡∏Å)";
  }

  function handleFlow() {
    var name = document.getElementById('userName').value;
    var region = document.getElementById('userRegion').value;
    if (!name || !region) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î‡∏†‡∏≤‡∏Ñ‡∏Ñ‡∏£‡∏±‡∏ö"); return; }
    
    if (selectedStatus === 'Report') processReport();
    else if (selectedStatus === 'Expenses') processExpense();
    else getGPS();
  }

  function getGPS() {
    if (!document.getElementById('q_loc').value || !document.getElementById('q_plan').value) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏Ñ‡∏£‡∏±‡∏ö"); return; }
    document.getElementById('status-text').innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏´‡∏≤‡∏û‡∏¥‡∏Å‡∏±‡∏î...";
    navigator.geolocation.getCurrentPosition(function(pos) {
      window.tempCoords = pos.coords.latitude + "," + pos.coords.longitude;
      document.getElementById('status-text').innerText = "üìç ‡∏û‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÅ‡∏•‡πâ‡∏ß! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ";
      document.getElementById('fileInput').click();
    }, err => alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î GPS ‡∏Ñ‡∏£‡∏±‡∏ö"), {enableHighAccuracy: true});
  }

  function uploadPhoto(input) {
    var reader = new FileReader();
    reader.onload = function(e) {
      var d = new Array(60).fill(""); 
      var now = new Date();
      d[0] = now.toLocaleDateString('th-TH'); // A: Date
      d[1] = now.toLocaleTimeString('th-TH'); // B: Time
      d[2] = document.getElementById('userName').value; // C: Name
      d[3] = window.tempCoords; // D: GeoStamp
      d[7] = selectedStatus; // H: Status
      d[8] = "Mobile"; // I: Device
      d[9] = document.getElementById('q_with').value; // J: WorkingWith
      d[10] = document.getElementById('q_car').value; // K: Vehicle
      d[11] = document.getElementById('q_mile').value; // L: Mileage
      d[12] = document.getElementById('q_loc').value; // M: LocationType
      d[13] = document.getElementById('q_plan').value; // N: Plan
      d[14] = document.getElementById('userRegion').value; // O: Region (‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î‡∏†‡∏≤‡∏Ñ)
      
      fetch(WEB_APP_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({ action: "SAVE_PHOTO", values: d, image: e.target.result, region: d[14] })}).then(finishDisplay);
    };
    reader.readAsDataURL(input.files[0]);
  }

  function processReport() {
    var repDate = document.getElementById('q_date_rep').value;
    if (!repDate || new Date(repDate).getFullYear() !== 2026) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡∏õ‡∏µ 2026 ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô"); return; }
    if (reportStep === 1 && document.getElementById('q_type').value === '‡∏á‡∏≤‡∏ô CR') {
      reportStep = 2; renderSite(1);
    } else { sendReportFinal(); }
  }

  function renderSite(n) {
    document.getElementById('report-section').style.display = 'none';
    document.getElementById('site-section').style.display = 'block';
    var div = document.createElement('div');
    div.innerHTML = `<div class="section-title">‡πÑ‡∏ã‡∏ï‡πå‡∏ó‡∏µ‡πà ${n}</div>
      <input type="text" id="s_name_${n}" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ã‡∏ï‡πå">
      <select id="s_job_${n}" onchange="document.getElementById('s_etc_${n}').style.display=(this.value=='‡∏≠‡∏∑‡πà‡∏ô ‡πÜ'?'block':'none')">
        <option value="">-- ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏á‡∏≤‡∏ô --</option>
        <option>‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà ‡πÇ‡∏ó‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ô‡∏±‡∏î‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Ñ‡∏°</option><option>‡∏•‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥ CR - CRL</option><option>‡∏•‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥ CR + ‡∏ô‡∏±‡∏î‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Ñ‡∏°</option><option>‡∏•‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà ‡∏ó‡∏≥‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Ñ‡∏°</option>
        <option>‡∏•‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥ CR + ‡∏ó‡∏≥‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Ñ‡∏°</option><option>‡∏•‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏´‡∏≤‡∏ó‡∏µ‡πà SA</option><option>‡∏•‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏õ‡∏£‡∏∞‡πÄ‡∏î‡πá‡∏ô (‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß)</option><option>‡∏≠‡∏∑‡πà‡∏ô ‡πÜ</option>
      </select>
      <input type="text" id="s_etc_${n}" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏ô‡∏¥‡∏î‡∏á‡∏≤‡∏ô" style="display:none;">
      <textarea id="s_det_${n}" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î"></textarea>
      ${n < 4 ? `<select id="next_${n}"><option value="‡∏™‡πà‡∏á">‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</option><option value="‡∏ï‡πà‡∏≠">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ã‡∏ï‡πå‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</option></select>` : ''}`;
    document.getElementById('site-container').appendChild(div);
    document.getElementById('btn-action').innerText = "‡∏ñ‡∏±‡∏î‡πÑ‡∏õ / ‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô";
    document.getElementById('btn-action').onclick = function() {
      if (document.getElementById(`next_${n}`)?.value === '‡∏ï‡πà‡∏≠') { siteIdx++; renderSite(siteIdx); } else { sendReportFinal(); }
    };
  }

  function sendReportFinal() {
    var d = new Array(60).fill("");
    d[0] = document.getElementById('q_date_rep').value;
    d[2] = document.getElementById('userName').value;
    d[7] = "Report"; d[14] = document.getElementById('userRegion').value; 
    d[15] = document.getElementById('q_type').value; d[17] = document.getElementById('q_job_detail').value;
    for(var i=1; i<=siteIdx; i++){
      var b = 18+((i-1)*6);
      d[b]=document.getElementById('s_name_'+i).value; d[b+2]=document.getElementById('s_job_'+i).value; d[b+3]=document.getElementById('s_etc_'+i)?.value; d[b+4]=document.getElementById('s_det_'+i).value;
    }
    fetch(WEB_APP_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({ action: "SAVE_REPORT", values: d })}).then(finishDisplay);
  }

  function processExpense() {
    if (expenseStep === 1) { expenseStep = 2; document.getElementById('expense-section').style.display='none'; document.getElementById('expense-upload').style.display='block'; }
    else if (expenseStep === 2) { 
      var total = ['ex_oil','ex_hotel','ex_ccr','ex_trav'].reduce((a,c)=>a+parseFloat(document.getElementById(c).value||0),0);
      document.getElementById('sum-total').innerText = "‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° 4 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£: " + total.toLocaleString() + " ‡∏ö‡∏≤‡∏ó";
      document.getElementById('expense-upload').style.display='none'; document.getElementById('expense-summary').style.display='block'; document.getElementById('btn-action').style.display='none';
    }
  }

  function confirmExpenseFinal() {
    var d = new Array(60).fill("");
    d[0] = document.getElementById('ex_date').value;
    d[2] = document.getElementById('userName').value;
    d[7] = "Expenses"; d[14] = document.getElementById('userRegion').value;
    d[42] = document.getElementById('ex_site').value;
    d[44] = document.getElementById('ex_oil').value; d[45] = document.getElementById('ex_hotel').value; d[46] = document.getElementById('ex_ccr').value; d[47] = document.getElementById('ex_trav').value;
    d[56] = document.getElementById('ex_date').value; // BE: EPSDate
    
    var promises = selectedFiles.map(f => new Promise(res => { var r = new FileReader(); r.onload = e => res({name:f.name, data:e.target.result}); r.readAsDataURL(f); }));
    Promise.all(promises).then(files => {
      fetch(WEB_APP_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({ action: "SAVE_EXPENSE", values: d, files: files, region: d[14] })}).then(finishDisplay);
    });
  }

  function finishDisplay() {
    document.getElementById('page-record').querySelectorAll('.card > *:not(#finish-msg)').forEach(el => el.style.display='none');
    document.getElementById('finish-msg').style.display = "block";
    if (['Check Out','Report','Expenses'].includes(selectedStatus)) {
      document.getElementById('finish-text-1').innerText = "‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡πà‡∏ß‡∏°‡∏°‡∏∑‡∏≠ ‡πÅ‡∏ö‡πà‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠ ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô ‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ö‡∏¥‡∏Å‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡∏∞";
      document.getElementById('finish-text-2').innerText = "Take care and Sleep well.";
    } else {
      document.getElementById('finish-text-1').innerText = "‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡πà‡∏ß‡∏°‡∏°‡∏∑‡∏≠ ‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ô‡∏∏‡∏Å‡∏™‡∏ô‡∏≤‡∏ô ‡∏Ñ‡∏¥‡∏î‡∏ñ‡∏∂‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å ‡πÄ‡∏Ñ‡∏≤‡∏£‡∏û‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏£‡πà‡∏ß‡∏°‡∏á‡∏≤‡∏ô";
      document.getElementById('finish-text-2').innerText = "Safety First and Have a nice day";
    }
  }
</script>
</body>
</html>
