<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    :root { --bg-color: #F7F9F9; --accent-blue: #1A73E8; }
    body { font-family: 'Segoe UI', Tahoma, sans-serif; padding: 10px; background-color: var(--bg-color); color: #546E7A; text-align: center; margin: 0; }
    .card { background: white; padding: 30px 20px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); max-width: 450px; margin: 20px auto; box-sizing: border-box; }
    .pos-btn { display: block; width: 100%; padding: 18px; margin: 12px 0; font-size: 19px; border: none; border-radius: 15px; cursor: pointer; font-weight: bold; color: #546E7A; transition: 0.3s; text-decoration: none; }
    .btn-site { background-color: #D4EBF8; } .btn-in { background-color: #E1F0DA; } .btn-out { background-color: #FFF9C4; }
    .btn-report { background-color: #FFCCBC; color: #BF360C; } .btn-expense { background-color: #FFE0B2; color: #E65100; }
    .status-display { font-size: 24px; font-weight: 900; color: var(--accent-blue); background: #E3F2FD; padding: 15px; border-radius: 15px; margin-bottom: 20px; }
    input, select, textarea { width: 100%; padding: 15px; margin-bottom: 15px; border: 1px solid #ECEFF1; border-radius: 12px; box-sizing: border-box; font-size: 16px; background: #FAFAFA; text-align: center; }
    .main-btn { padding: 18px; font-size: 18px; width: 100%; cursor: pointer; background-color: #A5D6A7; color: white; border: none; border-radius: 15px; font-weight: bold; }
    .section-title { font-weight: bold; color: var(--accent-blue); margin: 15px 0; text-align: left; border-left: 4px solid var(--accent-blue); padding-left: 10px; }
    #page-record, #group-check, #group-report, #site-section, #expense-section, #expense-upload, #expense-summary, #finish-msg { display: none; }
  </style>
</head>
<body>

  <div id="page-welcome" class="card">
    <h2 style="color:#78909C;">CODE of 2026 SCIn</h2>
    <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</p>
    <button type="button" class="pos-btn btn-site" onclick="selectStatus('Site Check In')">üìç Site Check In</button>
    <button type="button" class="pos-btn btn-in" onclick="selectStatus('Check In')">üí™ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô (Check In)</button>
    <button type="button" class="pos-btn btn-out" onclick="selectStatus('Check Out')">üò¥ ‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô (Check Out)</button>
    <button type="button" class="pos-btn btn-report" onclick="selectStatus('Report')">üìù Report (‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô)</button>
    <button type="button" class="pos-btn btn-expense" onclick="selectStatus('Expenses')">üí∞ Expenses (‡πÄ‡∏ö‡∏¥‡∏Å‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢)</button>
  </div>

  <div id="page-record" class="card">
    <div id="display-status" class="status-display"></div>
    <div id="status-text" style="margin-bottom:15px; font-weight:bold; color:orange;">‚è≥ ‡∏£‡∏∞‡∏ö‡∏∏‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô</div>

    <input type="text" id="userName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á)">
    <select id="userRegion">
      <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Region --</option>
      <option>BKK</option><option>CR</option><option>ER</option><option>NER</option><option>NR</option><option>SR</option><option>TE</option><option>DR</option><option>OFFICE</option>
    </select>

    <div id="group-check">
      <input type="text" id="q_buddy" placeholder="‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ñ‡∏π‡πà‡∏Å‡∏±‡∏ö‡πÉ‡∏Ñ‡∏£ (BUDDY)">
      <select id="q_car" onchange="document.getElementById('q_car_name').style.display=(this.value=='‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠'?'block':'none')">
        <option value="‡∏£‡∏ñ‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á">‡πÉ‡∏ä‡πâ‡∏£‡∏ñ‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á</option>
        <option value="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠">‡πÉ‡∏ä‡πâ‡∏£‡∏ñ‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô (‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠)</option>
      </select>
      <input type="text" id="q_car_name" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏£‡∏ñ" style="display:none;">
      <input type="number" id="q_mile" placeholder="‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå (Mileage)">
      <select id="q_loc">
        <option value="">-- ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà (PLACE) --</option>
        <option>‡∏≠‡∏≠‡∏ü‡∏ü‡∏¥‡∏ï</option><option>‡∏ö‡πâ‡∏≤‡∏ô/‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å</option><option>‡πÇ‡∏£‡∏á‡πÅ‡∏£‡∏°</option>
      </select>
      <textarea id="q_plan" rows="3" placeholder="PLAN / BRIFE"></textarea>
    </div>

    <div id="group-report">
      <input type="text" id="q_buddy_rep" placeholder="‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ñ‡∏π‡πà‡∏Å‡∏±‡∏ö‡πÉ‡∏Ñ‡∏£ (‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô)">
      <div class="section-title">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà?</div>
      <input type="date" id="q_date_rep">
      <select id="q_type" onchange="document.getElementById('q_type_etc').style.display=(this.value=='‡∏á‡∏≤‡∏ô ‡∏≠‡∏∑‡πà‡∏ô ‡πÜ'?'block':'none')">
        <option value="">-- ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô (TYPE) --</option>
        <option>‡∏á‡∏≤‡∏ô CR</option><option>‡∏á‡∏≤‡∏ô OFFICE</option><option>‡∏á‡∏≤‡∏ô TE</option><option>‡∏á‡∏≤‡∏ô DRONE</option><option>‡∏á‡∏≤‡∏ô ‡∏≠‡∏∑‡πà‡∏ô ‡πÜ</option>
      </select>
      <input type="text" id="q_type_etc" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏ô‡∏¥‡∏î‡∏á‡∏≤‡∏ô (ETC.)" style="display:none;">
      <textarea id="q_job_detail" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô (JobDetail)"></textarea>
    </div>

    <div id="site-section">
      <div id="site-container"></div>
    </div>

    <div id="expense-section">
      <input type="date" id="ex_date">
      <input type="text" id="ex_site" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ã‡∏ï‡πå">
      <input type="number" id="ex_oil" placeholder="‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô">
      <input type="number" id="ex_hotel" placeholder="‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å">
      <input type="number" id="ex_ccr" placeholder="‡∏Ñ‡πà‡∏≤‡∏Ç‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Ñ‡∏°">
      <input type="number" id="ex_trav" placeholder="‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á">
    </div>

    <div id="expense-upload">
      <div class="section-title">üì∏ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏ö‡∏¥‡∏• (‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 10 ‡∏£‡∏π‡∏õ)</div>
      <input type="file" id="ex_files" accept="image/*" multiple onchange="selectedFiles=Array.from(this.files); document.getElementById('f-count').innerText='‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß '+selectedFiles.length+' ‡∏£‡∏π‡∏õ'">
      <div id="f-count" style="color:green; margin-bottom:10px;"></div>
    </div>

    <div id="expense-summary">
      <div id="sum-total" style="font-size:20px; font-weight:bold; color:#2e7d32; margin-bottom:20px;"></div>
      <button type="button" class="main-btn" style="background:#2e7d32;" onclick="confirmExpenseFinal()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
    </div>

    <button type="button" id="btn-action" class="main-btn" onclick="handleFlow()">‡∏ï‡πà‡∏≠‡πÑ‡∏õ ‚ûî</button>

    <div id="finish-msg">
      <div style="font-size: 60px; color: #4CAF50;"><i class="fas fa-check-circle"></i></div>
      <div id="finish-text-1" style="font-size: 16px; margin: 15px 0;"></div>
      <div id="finish-text-2" style="font-weight: bold; color: #EF5350;"></div>
      <button type="button" class="main-btn" onclick="location.reload()" style="background:#1A73E8; margin-top:20px;">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button>
    </div>
  </div>

  <input type="file" id="fileInput" accept="image/*" capture="camera" style="display:none" onchange="uploadPhoto(this)">

<script>
  const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwk-spmOFdk-ZLRHhTkJXUshNWmJ6DqvdbNqUByszqLMDVujm7XFe0by-VDVUmNgZmuoQ/exec";
  var selectedStatus = "", reportStep = 1, siteIdx = 1, expenseStep = 1, selectedFiles = [];

  function selectStatus(status) {
    selectedStatus = status;
    document.getElementById('page-welcome').style.display = 'none';
    document.getElementById('page-record').style.display = 'block';
    document.getElementById('display-status').innerText = status;
    document.getElementById('group-check').style.display = (['Check In','Check Out','Site Check In'].includes(status)) ? 'block' : 'none';
    document.getElementById('group-report').style.display = (status === 'Report') ? 'block' : 'none';
    document.getElementById('expense-section').style.display = (status === 'Expenses') ? 'block' : 'none';
  }

  function handleFlow() {
    var name = document.getElementById('userName').value;
    var region = document.getElementById('userRegion').value;
    if (!name || !region) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡πÄ‡∏Ç‡∏ï"); return; }
    
    if (selectedStatus === 'Report') processReport();
    else if (selectedStatus === 'Expenses') processExpense();
    else getGPS();
  }

  function processReport() {
    var type = document.getElementById('q_type').value;
    if (reportStep === 1) {
      if (type === '‡∏á‡∏≤‡∏ô CR') {
        reportStep = 2; renderSite(1);
        document.getElementById('group-report').style.display = 'none';
        document.getElementById('site-section').style.display = 'block';
      } else { sendReportFinal(); }
    } else {
      var next = document.getElementById('next_site_'+siteIdx).value;
      if (next === '‡∏°‡∏µ‡πÑ‡∏ã‡∏ï‡πå‡∏ñ‡∏±‡∏î‡πÑ‡∏õ' && siteIdx < 4) {
        siteIdx++; renderSite(siteIdx);
      } else { sendReportFinal(); }
    }
  }

  function renderSite(n) {
    var container = document.getElementById('site-container');
    var div = document.createElement('div');
    div.id = 'site_page_' + n;
    div.innerHTML = `
      <div class="section-title">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏ã‡∏ï‡πå‡∏ó‡∏µ‡πà ${n}</div>
      ${n === 1 ? `<select id="site_region_job"><option value="">-- ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏†‡∏≤‡∏Ñ --</option><option>BKK</option><option>CR</option><option>ER</option><option>NER</option><option>NR</option><option>SR</option></select>` : ''}
      <input type="text" id="site_name_${n}" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ã‡∏ï‡πå (Site${n})">
      <input type="text" id="site_prov_${n}" placeholder="‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î (Province${n})">
      <select id="site_job_${n}" onchange="document.getElementById('site_etc_${n}').style.display=(this.value=='‡∏≠‡∏∑‡πà‡∏ô ‡πÜ'?'block':'none')">
        <option value="">-- ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏á‡∏≤‡∏ô --</option>
        <option>‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà ‡πÇ‡∏ó‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ô‡∏±‡∏î‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Ñ‡∏°</option><option>‡∏•‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥ CR - CRL</option><option>‡∏•‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥ CR + ‡∏ô‡∏±‡∏î‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Ñ‡∏°</option><option>‡∏•‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà ‡∏ó‡∏≥‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Ñ‡∏°</option>
        <option>‡∏•‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥ CR + ‡∏ó‡∏≥‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Ñ‡∏°</option><option>‡∏•‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏´‡∏≤‡∏ó‡∏µ‡πà SA</option><option>‡∏•‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏õ‡∏£‡∏∞‡πÄ‡∏î‡πá‡∏ô (‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß)</option><option>‡∏≠‡∏∑‡πà‡∏ô ‡πÜ</option>
      </select>
      <input type="text" id="site_etc_${n}" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏ô‡∏¥‡∏î‡∏á‡∏≤‡∏ô" style="display:none;">
      <textarea id="site_det_${n}" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô (JobSiteDetail${n})"></textarea>
      <input type="text" id="site_ld_${n}" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ô‡∏≥-‡πÅ‡∏•‡∏∞‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ (LDSite${n})">
      ${n < 4 ? `<select id="next_site_${n}"><option value="‡πÑ‡∏°‡πà‡∏°‡∏µ">‡πÑ‡∏°‡πà‡∏°‡∏µ</option><option value="‡∏°‡∏µ‡πÑ‡∏ã‡∏ï‡πå‡∏ñ‡∏±‡∏î‡πÑ‡∏õ">‡∏°‡∏µ‡πÑ‡∏ã‡∏ï‡πå‡∏ó‡∏µ‡πà ${n+1}</option></select>` : `<input type="hidden" id="next_site_${n}" value="‡πÑ‡∏°‡πà‡∏°‡∏µ">`}
    `;
    // ‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ã‡∏ï‡πå‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏™‡∏î‡∏á‡πÑ‡∏ã‡∏ï‡πå‡πÉ‡∏´‡∏°‡πà
    if(n > 1) document.getElementById('site_page_'+(n-1)).style.display = 'none';
    container.appendChild(div);
  }

  function sendReportFinal() {
    var d = new Array(60).fill("");
    d[0] = document.getElementById('q_date_rep').value;
    d[2] = document.getElementById('userName').value;
    d[7] = "Report"; d[9] = document.getElementById('q_buddy_rep').value;
    d[14] = document.getElementById('userRegion').value;
    d[15] = document.getElementById('q_type').value; 
    d[16] = document.getElementById('q_type_etc').value;

    if (d[15] === '‡∏á‡∏≤‡∏ô CR') {
      d[17] = document.getElementById('site_region_job').value; // JobRegion
      for(var i=1; i<=siteIdx; i++) {
        var base = 18 + ((i-1)*6);
        d[base] = document.getElementById('site_name_'+i).value;
        d[base+1] = document.getElementById('site_prov_'+i).value;
        d[base+2] = document.getElementById('site_job_'+i).value;
        d[base+3] = document.getElementById('site_etc_'+i).value;
        d[base+4] = document.getElementById('site_det_'+i).value;
        d[base+5] = document.getElementById('site_ld_'+i).value;
      }
    } else {
      d[17] = document.getElementById('q_job_detail').value; // JobDetail (Non-CR)
    }
    fetch(WEB_APP_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({ action: "SAVE_REPORT", values: d, region: d[14] })}).then(finishDisplay);
  }

  function getGPS() {
    document.getElementById('status-text').innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏´‡∏≤‡∏û‡∏¥‡∏Å‡∏±‡∏î...";
    navigator.geolocation.getCurrentPosition(function(pos) {
      window.tempCoords = pos.coords.latitude + "," + pos.coords.longitude;
      document.getElementById('fileInput').click();
    }, err => alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î GPS"), {enableHighAccuracy: true});
  }

  function uploadPhoto(input) {
    var reader = new FileReader();
    reader.onload = function(e) {
      var d = new Array(60).fill("");
      var now = new Date();
      d[0] = now.toLocaleDateString('th-TH'); d[1] = now.toLocaleTimeString('th-TH');
      d[2] = document.getElementById('userName').value;
      d[3] = window.tempCoords; d[7] = selectedStatus; d[8] = "Mobile";
      d[9] = document.getElementById('q_buddy').value;
      d[10] = document.getElementById('q_car').value === '‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠' ? document.getElementById('q_car_name').value : document.getElementById('q_car').value;
      d[11] = document.getElementById('q_mile').value;
      d[12] = document.getElementById('q_loc').value;
      d[13] = document.getElementById('q_plan').value;
      d[14] = document.getElementById('userRegion').value;
      fetch(WEB_APP_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({ action: "SAVE_PHOTO", values: d, image: e.target.result, region: d[14] })}).then(finishDisplay);
    };
    reader.readAsDataURL(input.files[0]);
  }

  function processExpense() {
    if (expenseStep === 1) {
      expenseStep = 2; document.getElementById('expense-section').style.display='none'; document.getElementById('expense-upload').style.display='block';
    } else if (expenseStep === 2) {
      var total = ['ex_oil','ex_hotel','ex_ccr','ex_trav'].reduce((a,c)=>a+parseFloat(document.getElementById(c).value||0),0);
      document.getElementById('sum-total').innerText = "‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: " + total.toLocaleString() + " ‡∏ö‡∏≤‡∏ó";
      document.getElementById('expense-upload').style.display='none'; document.getElementById('expense-summary').style.display='block'; document.getElementById('btn-action').style.display='none';
    }
  }

  function confirmExpenseFinal() {
    var d = new Array(60).fill("");
    d[0] = document.getElementById('ex_date').value;
    d[2] = document.getElementById('userName').value;
    d[7] = "Expenses"; d[14] = document.getElementById('userRegion').value;
    d[42] = document.getElementById('ex_site').value;
    d[44] = document.getElementById('ex_oil').value; d[45] = document.getElementById('ex_hotel').value; d[46] = document.getElementById('ex_ccr').value; d[47] = document.getElementById('ex_trav').value;
    d[56] = document.getElementById('ex_date').value;
    var promises = selectedFiles.map(f => new Promise(res => { var r = new FileReader(); r.onload = e => res({name:f.name, data:e.target.result}); r.readAsDataURL(f); }));
    Promise.all(promises).then(files => {
      fetch(WEB_APP_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({ action: "SAVE_EXPENSE", values: d, files: files, region: d[14] })}).then(finishDisplay);
    });
  }

  function finishDisplay() {
